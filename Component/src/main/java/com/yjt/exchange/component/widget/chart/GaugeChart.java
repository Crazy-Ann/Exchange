/**
 * Copyright 2014  XCL-Charts
 * <p>
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 * <p>
 * http://www.apache.org/licenses/LICENSE-2.0
 * <p>
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *
 * @Project XCL-Charts
 * @Description Android图表基类库
 * @author XiongChuanLiang<br                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               />(xcl_168@aliyun.com)
 * @license http://www.apache.org/licenses/  Apache v2 License
 * @version 1.0
 */

package com.hynet.heebit.components.widget.chart;

import android.graphics.Canvas;
import android.graphics.Color;
import android.graphics.Paint;
import android.graphics.Paint.Align;
import android.graphics.Paint.Style;
import android.graphics.RectF;
import android.util.Pair;

import com.hynet.heebit.components.utils.LogUtil;
import com.hynet.heebit.components.widget.chart.constant.ChartType;
import com.hynet.heebit.components.widget.chart.renderer.CirChart;
import com.hynet.heebit.components.widget.chart.utils.DrawUtil;
import com.hynet.heebit.components.widget.chart.utils.MathUtil;

import java.util.List;

public class GaugeChart extends CirChart {

    //刻度步长
    private double tickSteps = 10d;
    //标签
    private List<String> labels = null;
    //刻度
    private Paint tickPaint = null;
    //指针
    private float pointerAngle = 20f;
    private Paint pointerLinePaint = null;
    private Paint pinterCirclePaint = null;
    //分区填充色(比如绿，黄，红),以使区域更清楚
    private Paint partitionFillPaint = null;
    //环
    private Paint dountPaint = null;
    //分区填充数据源(角色(0-180)，颜色)
    private List<Pair> pairs = null;
    //180度
    private static final int START_ANGLE = 180;


    public GaugeChart() {
        initPaint();
    }

    @Override
    public ChartType getType() {
        return ChartType.GAUGE;
    }

    private void initPaint() {
        getLabelPaint().setTextSize(18);
        getLabelPaint().setColor(Color.BLUE);
        if (null == tickPaint) {
            tickPaint = new Paint();
            tickPaint.setStyle(Style.FILL);
            tickPaint.setAntiAlias(true);
            tickPaint.setColor(Color.rgb(50, 149, 222));
            tickPaint.setStrokeWidth(1);
        }
        if (null == pointerLinePaint) {
            pointerLinePaint = new Paint();
            pointerLinePaint.setStyle(Style.FILL);
            pointerLinePaint.setAntiAlias(true);
            pointerLinePaint.setColor(Color.BLACK);
            pointerLinePaint.setStrokeWidth(3);
        }
        if (null == pinterCirclePaint) {
            pinterCirclePaint = new Paint();
            pinterCirclePaint.setStyle(Style.FILL);
            pinterCirclePaint.setAntiAlias(true);
            pinterCirclePaint.setColor(Color.BLACK);
            pinterCirclePaint.setStrokeWidth(8);
        }
        if (null == partitionFillPaint) {
            partitionFillPaint = new Paint();
            partitionFillPaint.setStyle(Style.FILL);
            partitionFillPaint.setAntiAlias(true);
        }
        if (null == dountPaint) {
            dountPaint = new Paint();
            dountPaint.setStyle(Style.STROKE);
            dountPaint.setColor(Color.rgb(50, 149, 222));
            dountPaint.setAntiAlias(true);
            dountPaint.setStrokeWidth(2);
        }
    }

    /**
     * 开放刻度画笔
     *
     * @return 画笔
     */
    public Paint getTickPaint() {
        return tickPaint;
    }

    /**
     * 开放指针画笔
     *
     * @return 画笔
     */
    public Paint getPinterCirclePaint() {
        return pinterCirclePaint;
    }

    /**
     * 开放指针底部圆画笔
     *
     * @return 画笔
     */
    public Paint getPointerLinePaint() {
        return pointerLinePaint;
    }

    /**
     * 开放用来绘制颜色分区的画笔
     *
     * @return 画笔
     */
    public Paint getPartitionFillPaint() {
        return partitionFillPaint;
    }

    /**
     * 开放用来绘制外围环的画笔
     *
     * @return 画笔
     */
    public Paint getDountPaint() {
        return dountPaint;
    }

    /**
     * 绘制饼图中显示所占比例 的扇区
     *
     * @param paintArc    画笔
     * @param cirX        x坐标
     * @param cirY        y坐标
     * @param radius      半径
     * @param offsetAngle 偏移角度
     * @param curretAngle 当前角度
     *
     * @throws Exception 例外
     */
    protected void drawPercent(Canvas canvas, Paint paintArc, final float cirX, final float cirY, final float radius, final float offsetAngle, final float curretAngle) {
        float arcLeft = sub(cirX, radius);
        float arcTop = sub(cirY, radius);
        float arcRight = add(cirX, radius);
        float arcBottom = add(cirY, radius);
        RectF arcRF0 = new RectF(arcLeft, arcTop, arcRight, arcBottom);
        //在饼图中显示所占比例  
        canvas.drawArc(arcRF0, offsetAngle, curretAngle, true, paintArc);
    }

    /**
     * 设置刻度步长
     *
     * @param step 步长
     */
    public void setTickSteps(double step) {
        tickSteps = step;
    }

    /**
     * 设置标签集合,即显示在最外圈的那个文字标签。(标签和步长分开，步长即刻度可以密点，标签可以松点)
     *
     * @param categories 标签集合
     */
    public void setCategories(List<String> categories) {
        labels = categories;
    }


    /**
     * 设置分区填充数据集，[角度(0-START_ANGLE)，颜色]，用以决定绘制多少个颜色区分，其所显示大小是多少.
     *
     * @param dataSet 角度,颜色
     */
    public void setPartition(List<Pair> dataSet) {
        pairs = dataSet;
    }


    /**
     * 设置指针指向的角度(0-180).
     *
     * @param Angle 角度
     */
    public void setCurrentAngle(float Angle) {
        pointerAngle = Angle;
    }

    private void renderLabels(Canvas canvas) {
        if (null == labels) return;
        float stepsAngle = Math.round(180 / (labels.size() - 1));
        float radius = getRadius();
        float calcRadius = add(radius, div(radius, 10f));
        float cirX = plotAreaRender.getCenterX();
        //float cirY = plotAreaRender.getCenterY();
        float cirY = getCirY();
        getLabelPaint().setTextAlign(Align.CENTER);
        int i = 0;
        for (String label : labels) {
            if (0 == i) {//开头
                canvas.drawText(label, cirX - calcRadius, cirY, this.getLabelPaint());
            } else if (i == labels.size() - 1) { //结尾
                canvas.drawText(label, cirX + calcRadius, cirY, this.getLabelPaint());
            } else {
                //计算百分比标签
                MathUtil.getInstance().calcArcEndPointXY(cirX, cirY, calcRadius, 180f + i * stepsAngle);
                //标识
                canvas.drawText(label, MathUtil.getInstance().getPosX(), MathUtil.getInstance().getPosY(), this.getLabelPaint());
            }
            i++;
        }
    }

    /**
     * 绘制刻度
     */
    private void renderTicks(Canvas canvas) {
        //步长角度		
        Double value = Double.valueOf(tickSteps);
        float stepsAngle = div(180.0f, value.floatValue());
        float cirX = plotAreaRender.getCenterX();
        float cirY = getCirY(); //plotAreaRender.getCenterY();
        float tickRadius = mul(getRadius(), 0.9f);
        for (int i = 0; i < tickSteps; i++) {
            if (0 == i) continue;
            float Angle = (float) MathUtil.getInstance().add(180d, i * stepsAngle);
            MathUtil.getInstance().calcArcEndPointXY(cirX, cirY, getRadius(), Angle);
            float startX = MathUtil.getInstance().getPosX();
            float startY = MathUtil.getInstance().getPosY();
            MathUtil.getInstance().calcArcEndPointXY(cirX, cirY, tickRadius, Angle);
            canvas.drawLine(startX, startY, MathUtil.getInstance().getPosX(), MathUtil.getInstance().getPosY(), tickPaint);
        }
    }

    /**
     * 绘制指针
     */
    private void renderPointerLine(Canvas canvas) {
        float currentRadius = mul(getRadius(), 0.9f);
        float cirX = plotAreaRender.getCenterX();
        float cirY = getCirY(); //plotAreaRender.getCenterY();

        if (Float.compare(pointerAngle, 180f) == 0 || Float.compare(pointerAngle, 180f) == 1) {//爆表了 
            canvas.drawLine(cirX, cirY, cirX + currentRadius, cirY, pointerLinePaint);
        } else if (Float.compare(pointerAngle, 0.0f) == 0 || Float.compare(pointerAngle, 0.0f) == -1) {
            canvas.drawLine(cirX, cirY, cirX - currentRadius, cirY, pointerLinePaint);
        } else {
            float calcAngle = add(pointerAngle, START_ANGLE);
            MathUtil.getInstance().calcArcEndPointXY(cirX, cirY, currentRadius, calcAngle);
            float endX = MathUtil.getInstance().getPosX();
            float endY = MathUtil.getInstance().getPosY();
            if (Float.compare(endY, cirY) == 1) endY = cirY;
            canvas.drawLine(cirX, cirY, endX, endY, pointerLinePaint);
        }
    }

    /**
     * 绘制指针底部的圆
     */
    private void renderPinterCircle(Canvas canvas) {
        float cirX = plotAreaRender.getCenterX();
        float cirY = getCirY(); //plotAreaRender.getCenterY();
        canvas.drawCircle(cirX, cirY, mul(this.getRadius(), 0.05f), pinterCirclePaint);
    }


    /**
     * 绘制内部颜色分区填充
     *
     * @throws Exception
     */
    private boolean renderPartitionFill(Canvas canvas) {
        if (null == pairs || pairs.size() == 0) {
             LogUtil.Companion.getInstance().print("数据源为空.");
            return false;
        }
        float totalAngle = 0.0f;
        float newRadius = mul(getRadius(), 0.8f);
        float cy = getCirY();
        RectF rect = new RectF();
        rect.left = sub(plotAreaRender.getCenterX(), newRadius);
        rect.top = sub(cy, newRadius);
        rect.right = add(plotAreaRender.getCenterX(), newRadius);
        rect.bottom = add(cy, newRadius);
        for (Pair pr : pairs) {
            Float AngleValue = (Float) pr.first;
            float total = add(totalAngle, AngleValue);
            if (Float.compare(AngleValue, 0.0f) < 0) {
                 LogUtil.Companion.getInstance().print("负角度???!!!");
            } else if (Float.compare(total, 180.0f) == 1) { //(totalAngle + AngleValue) > 180)
                 LogUtil.Companion.getInstance().print("输入的角度总计大于180度");
                return false;
            }
            partitionFillPaint.setColor((Integer) pr.second);
            canvas.drawArc(rect, add(totalAngle, 180.0f), AngleValue, true, partitionFillPaint);
            totalAngle = add(totalAngle, AngleValue);
        }
        rect = null;
        return false;
    }

    private float getCirY() {
        float cirY = this.getBottom();
        if (this.isShowBorder()) {
            cirY -= this.getBorderWidth() / 2;
        }
        cirY -= mul(getRadius(), 0.05f); //底圆
        return cirY;
    }

    @Override
    public float getRadius() {
        //半圆， 宽应当是高的两倍
        float r = getWidth() / 2.f;
        if (this.isShowBorder()) {
            r -= this.getBorderWidth();
        }

        //找第一和最后一个标签
        if (null != labels && labels.size() > 0) {
            int e = labels.size() - 1;
            float left = DrawUtil.getInstance().getTextWidth(getLabelPaint(), labels.get(0));
            float right = DrawUtil.getInstance().getTextWidth(getLabelPaint(), labels.get(e));
            float spadding = Math.max(left, right);
            r = sub(r, spadding);
            r = sub(r, this.getBorderWidth() / 2);
        }
        r -= mul(r, 0.05f); //底圆
        return r;
    }

    /**
     * 绘制环
     *
     * @throws Exception
     */
    private void renderDount(Canvas canvas) {
        drawPercent(canvas, dountPaint, plotAreaRender.getCenterX(), getCirY(), getRadius(), 180, 180);
    }

    /**
     * 绘制图
     */
    protected void renderPlot(Canvas canvas) {
        //外环
        renderDount(canvas);
        //依角度画好刻度线
        // 计算出坐标点,从圆心到点间画线
        renderTicks(canvas);
        //画上用于标识分区的扇区
        renderPartitionFill(canvas);
        //画上外围标签
        renderLabels(canvas);
        //最后再画指针
        renderPointerLine(canvas);
        //画上指针尾部的白色圆心
        renderPinterCircle(canvas);
    }


    @Override
    protected boolean postRender(Canvas canvas) {
        super.postRender(canvas);
        //绘制图表
        renderPlot(canvas);
        return true;
    }
}
